---
- hosts: all
  vars:
    ssh_key_filename: id_rsa
    gitrepo: https://github.com/bortolo/Ansible_playbooks.git
    # CHANGE HERE
    # Set the host name of your servers (must be aligned with the one of terraform)
    host_user: myadmin
    script_name: ConnectWithServers.sh
    yml_azure_rm_file: myazure_rm.yml
    yml_file_to_deploy_web: deploy-webservers.yml
    yml_file_to_deploy_app: deploy-appservers.yml
    # CHANGE HERE
    # Set your local path to AZURE credintial file
    path_for_azure_credentials: /Users/andreabortolossi/Documents/Documents – Andrea’s MacBook Pro/Coding projects/Secrets/credentials
    path_for_playbooks: "/home/{{host_user}}/ansibleplaybooks"
    # CHANGE HERE
    # 1) Create an ansible vault record for the server password (must be ailgned with the one that you set up in terraform)
    #     ansible-vault encrypt_string --vault-id @prompt [your_secure_password]
    # 2) Copy here the encrypted key generated by ansible
    # 3) Run the ansible-playbook command with the option "--vault-id @prompt"
    # https://www.golinuxcloud.com/ansible-vault-example-encrypt-string-playbook/#8_Using_ansible_vault_in_playbook
    server_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32343265306437396662336364633366356132396131386164343661613736373032643962623733
          3635313936376335623464343334363264666534383736640a383465343164346564363764366338
          35613766623837376637333436663431306666636161313230613761613261353735316635346239
          3766336233326337650a643763313464623133386462306331626137613635323935623635373965
          3664

  tasks:
    - name: generate SSH key "{{ssh_key_filename}}"
      openssh_keypair:
        path: "~/.ssh/{{ssh_key_filename}}"
    - name: Install pip depdencdecies to manage azure-mgmt-resource
      pip:
        name: azure-mgmt-resource
    - name: Pull file from source
      git:
        repo: "{{gitrepo}}"
        dest: "{{path_for_playbooks}}"
        update: yes
        version: master
        force: yes
    - name: Create AZURE directory
      file:
        path: "/home/{{host_user}}/.azure"
        state: directory
    - name: Copy file with AZURE credentials
      copy:
       src: "{{path_for_azure_credentials}}"
       dest: "/home/{{host_user}}/.azure/credentials"
    - name: Make executable "{{script_name}}"
      file:
        dest: "{{path_for_playbooks}}/{{script_name}}"
        mode: a+x
    - name: Execute "{{script_name}}"
      command: ./{{script_name}} {{server_password}}
      args:
        chdir: "{{path_for_playbooks}}"
    - name: Configure and launch application servers
      command: ansible-playbook -i ./{{yml_azure_rm_file}} {{yml_file_to_deploy_app}} -l tag_environment_app
      args:
        chdir: "{{path_for_playbooks}}"
    - name: Configure and launch web servers
      command: ansible-playbook -i ./{{yml_azure_rm_file}} {{yml_file_to_deploy_web}} -l tag_environment_web
      args:
        chdir: "{{path_for_playbooks}}"
